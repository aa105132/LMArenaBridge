name: Sisyphus Agent

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: "Custom prompt"
        required: false
  issue_comment:
    types: [created]

jobs:
  agent:
    runs-on: ubuntu-latest
    # Trigger on mention of @sisyphus-dev-ai by authorized users
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' &&
        contains(github.event.comment.body || '', '@sisyphus-dev-ai') &&
        (github.event.comment.user.login || '') != 'sisyphus-dev-ai' &&
        contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association || ''))

    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "sisyphus-dev-ai"
          git config user.email "sisyphus-dev-ai@users.noreply.github.com"

      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.GH_PAT }}" | gh auth login --with-token

      - name: Setup Runtime (Bun & tmux)
        run: |
          sudo apt-get update && sudo apt-get install -y --no-install-recommends tmux
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Build Local Plugin (oh-my-opencode)
        run: |
          export PATH="$HOME/.bun/bin:$PATH"
          bun install
          bun run build

      - name: Setup OpenCode & Antigravity Bridge
        env:
          ANTIGRAVITY_AUTH: ${{ secrets.ANTIGRAVITY_AUTH_JSON }}
          OPENCODE_AUTH: ${{ secrets.OPENCODE_AUTH_JSON }}
        run: |
          export PATH="$HOME/.opencode/bin:$PATH"
          
          # Install OpenCode CLI
          if ! command -v opencode &>/dev/null; then
            curl -fsSL https://opencode.ai/install | bash
          fi
          
          # Install Antigravity Bridge Plugin (NoeFabris version)
          opencode plugin add opencode-antigravity-auth@1.2.7

          # Configure account sessions for the bridge
          mkdir -p ~/.config/opencode
          echo "$ANTIGRAVITY_AUTH" > ~/.config/opencode/antigravity-accounts.json
          
          # Inject OMO config and set models to use Antigravity IDs
          # We use Gemini 3 Pro High as the primary engine through the bridge
          opencode config set provider google
          opencode config set model antigravity-gemini-3-pro-high

      - name: Collect Context
        id: context
        run: |
          ISSUE_NUM="${{ github.event.issue.number }}"
          REPO="${{ github.repository }}"
          ISSUE_DATA=$(gh api "repos/$REPO/issues/${ISSUE_NUM}")
          
          if echo "$ISSUE_DATA" | jq -e '.pull_request' > /dev/null; then
            echo "type=pr" >> $GITHUB_OUTPUT
          else
            echo "type=issue" >> $GITHUB_OUTPUT
          fi
          
          echo "number=$ISSUE_NUM" >> $GITHUB_OUTPUT
          echo "title=$(echo "$ISSUE_DATA" | jq -r '.title')" >> $GITHUB_OUTPUT
          echo "author=${{ github.event.comment.user.login }}" >> $GITHUB_OUTPUT
          echo "comment_id=${{ github.event.comment.id }}" >> $GITHUB_OUTPUT
          
          echo "comment<<EOF" >> $GITHUB_OUTPUT
          echo "${{ github.event.comment.body }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Feedback (Eyes Reaction)
        if: steps.context.outputs.comment_id != ''
        run: |
          gh api "/repos/${{ github.repository }}/issues/comments/${{ steps.context.outputs.comment_id }}/reactions" \
            -X POST -f content="eyes" || true

      - name: Run Sisyphus Agent
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          export PATH="$HOME/.opencode/bin:$HOME/.bun/bin:$PATH"
          
          # Construct the final prompt with UltraWork Mode instructions
          PROMPT=$(cat <<'EOF'
          <ultrawork-mode>
          [CODE RED] You are @sisyphus-dev-ai, an autonomous agent using the Antigravity Bridge.
          
          ## CAPABILITIES (Parallel Agent Spawning)
          - Exploration: background_task for project structure.
          - Reasoning: Use Antigravity-Gemini-3-Pro-High for complex logic.
          - Planning: Spawn a plan agent before every task.

          ## ZERO TOLERANCE
          - No mock data. No "starting points". Deliver 100% working code.
          - Never stop at 80%. Complete all TODOs before reporting.

          ## GITHUB OPS
          - Always use heredoc `cat <<'EOF'` for comments.
          - All code changes must be in a PR.
          </ultrawork-mode>

          ---
          Context: ${{ steps.context.outputs.title }} (#${{ steps.context.outputs.number }})
          Author: @${{ steps.context.outputs.author }}
          Request: ${{ steps.context.outputs.comment }}
          EOF
          )

          # Execute using the local build of oh-my-opencode
          # Use stdbuf to ensure logs are streamed to GitHub Actions console
          stdbuf -oL -eL bun run dist/cli/index.js run "$PROMPT" --model google/antigravity-gemini-3-pro-high

      - name: Cleanup & Close
        if: always()
        run: |
          # Remove working label and add +1
          if [[ -n "${{ steps.context.outputs.comment_id }}" ]]; then
            gh api "/repos/${{ github.repository }}/issues/comments/${{ steps.context.outputs.comment_id }}/reactions" \
              -X POST -f content="+1" || true
          fi
